<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LP Mood Wheel – 5day Test</title>
  <style>
    html, body { height:100%; margin:0; background:#0d0f15; overflow:hidden; }
    #c { display:block; width:100vw; height:100vh; }
    button.nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  background:transparent;
  border:none;
  outline:none;
  cursor:pointer;
  user-select:none;

  width:88px; height:88px;           /* 2배 크기 */
  display:grid; place-items:center;
  transition:opacity .2s, transform .15s;
  opacity:.85;
}
button.nav:hover{
  opacity:1;
  transform:translateY(-50%) scale(1.05);
}
button.nav:active{
  transform:translateY(-50%) scale(0.96);
}

/* 위치 */
#prev{ left:2%; }
#next{ right:2%; }

/* 기본 화살표 (연한 회색) */
button.nav svg{
  width:50px; height:50px;
  stroke:#bfbfbf;
  stroke-width:1.0;
  fill:none;
  stroke-linecap:round;
  stroke-linejoin:round;
  transition:stroke .2s ease, opacity .2s ease;
  opacity:.9;
  pointer-events:none; /* 클릭 감지 방지 (버튼 전체 클릭) */
}

/* ✅ hover 시 화살표만 확실히 하얗게 */
button.nav:hover svg{
  stroke:#ffffff !important;
  opacity:1 !important;
  filter:drop-shadow(0 0 3px rgba(255,255,255,0.6)); /* 미세한 발광 */
}

/* --- Tooltip --- */
#tooltip {
  background: rgba(11,13,19,0.92);                 /* 약간 더 차분함 */
  color: #E2E6F3;                                   /* 미세 톤다운 */
  font: 12.5px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; /* 0.5px 낮춰 정교함 */
  padding: 8px 10px;
  border: 1px solid rgba(255,255,255,0.10);         /* 경계 과장 줄임 */
  border-radius: 8px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.32);          /* 섀도우 살짝 축소 */
  pointer-events: none;
  white-space: nowrap;
}
#tooltip .row {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
#tooltip .dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex: 0 0 10px;
  border: 1px solid rgba(255,255,255,0.25);
}
#tooltip .text {
  letter-spacing: 0.1px;
}
  </style>
</head>
<body>
  <canvas id="c"></canvas>
 <button id="prev" class="nav" aria-label="이전 날짜">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M15 6l-6 6 6 6"></path>
  </svg>
</button>

<button id="next" class="nav" aria-label="다음 날짜">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M9 6l6 6-6 6"></path>
  </svg>
</button>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let dpr = window.devicePixelRatio || 1;
let W, H;
function fit(){
  W = canvas.width = window.innerWidth * dpr;
  H = canvas.height = window.innerHeight * dpr;
}
window.addEventListener('resize', fit);
fit();

const DEG = Math.PI / 180;
let trailMode = true; // 잔상 모드 ON/OFF (T키로 토글)
let currentSegments = [];                  // 현재 날짜의 조각 정보(툴팁용)
let lastClient = { x: 0, y: 0 };           // ← 추가 2: 툴팁 위치용 윈도우 좌표

let baseSpeed = 60 * DEG; // 기본 회전 속도
let angle = 0;
let pointer = {x: Infinity, y: Infinity};
window.addEventListener('mousemove', e => {
  const rect = canvas.getBoundingClientRect();
  pointer.x = (e.clientX - rect.left)*dpr;
  pointer.y = (e.clientY - rect.top)*dpr;

  lastClient.x = e.clientX;  // ← 추가
  lastClient.y = e.clientY;  // ← 추가
});
window.addEventListener('mouseleave', ()=>{
  pointer.x = Infinity; pointer.y = Infinity;
});

// ==== 테스트용 데일리 데이터 ====
const days = [
  {
    date: "2025-10-30",
    colors: [
      { hex: "#F20C8B", count: 20, title: "다시 밤이 없겠고(LIVE)", artist: "잔치공동체" }, 
      { hex: "#DBA99E", count: 7, title: "S.O.S(Song Of Songs)", artist: "히스플랜" }, 
      { hex: "#F2CD5C", count: 1, title: "Cherry", artist: "Jordan Susanto" }, 
      { hex: "#04BFAD", count: 1, title: "내가 늘 의지하는 예수", artist: "어노인팅" }, 
      { hex: "#F2E9BD", count: 1, title: "I'll Rejoice In The Lord", artist: "Annointing" }, 
      { hex: "#3F6F8C", count: 1, title: "Secret Codes", artist: "Anthony Lazaro" }, 
      { hex: "#BFBFBF", count: 1, title: "So Easy(To Fall In Love)", artist: "Olivia Dean" }, 
      { hex: "#F2A29B", count: 1, title: "감사함으로", artist: "J-US" }, 
      { hex: "#A65389", count: 1, title: "Dive", artist: "Olivia Dean" },
      { hex: "#7AB3BF", count: 1, title: "기쁨의 날 주시네 Your Given Day (인도: 소진영)", artist: "마커스워십" }, 
      { hex: "#818C2B", count: 1, title: "Life Be Worship", artist: "NEWAVE" }, 
      { hex: "#F2B035", count: 1, title: "나의 하나님", artist: "심형진" }, 
      { hex: "#260101", count: 1, title: "Love Never Fails", artist: "J-US" }, 
      { hex: "#5B458C", count: 3, title: "내 마음 다해", artist: "Markers" }, 
    ]
  },
  {
    date: "2025-10-31",
    colors: [
      { hex: "#595959", count: 4, title: "Cry", artist: "Cigarettes After Sex" }, 
      { hex: "#727372", count: 1, title: "Nothing's Gonna Hurt You Baby", artist: "Cigarettes After Sex" }, 
      { hex: "#736F68", count: 4, title: "Complicated", artist: "Matt Maltese" }, 
      { hex: "#F27405", count: 2, title: "My Love Mine All Mine", artist: "Mitski" }, 
      { hex: "#275AF2", count: 1, title: "Ever", artist: "Tuesday Beach Club" }, 
      { hex: "#3A5936", count: 1, title: "Green", artist: "12BH" }, 
      { hex: "#F2F2F2", count: 2, title: "Oh Rosy", artist: "Milena" }, 
      { hex: "#F2B3C4", count: 1, title: "Dancing on the table", artist: "Milena" },
      { hex: "#84A9BF", count: 1, title: "All I Ever Asked", artist: "Rachel Chinouriri" },
      { hex: "#394759", count: 1, title: "Cigarette Butt", artist: "Bubble Tea and Cigarettes" },
      { hex: "#BF7330", count: 1, title: "Best Part(feat. H.E.R)", artist: "Daniel Caesar" },
      { hex: "#244E73", count: 1, title: "Elusive", artist: "Lianne La Havas" },
      { hex: "#A69C6D", count: 1, title: "Dear Teddy Bear", artist: "JISOKURY" },
      { hex: "#F2F2F2", count: 1, title: "Everything Happens To Me", artist: "Duke Jordan" },
      { hex: "#AC8FBF", count: 1, title: "Crazy", artist: "Hope Tala" },
      { hex: "#485DD9", count: 3, title: "다시 일어나 (LIVE)", artist: "WELOVE" }
        
    ]
  },
  { date: "2025-11-01", 
  colors: [
    {hex:"#BF2121", count:1, title: "우리들의 순간", artist: "브라운 아이드 소울" }, 
    {hex:"#D9C091", count:1, title: "왠지 그럼 안될 것 같아(2021 월간 윤종신 Repir 2월호)", artist: "윤종신 및 미유" },
    {hex:"#F20C0C", count:1, title: "Wish", artist: "Tuesday Beach Club" },
    {hex:"#F27405", count:1, title: "Her", artist: "Tuesday Beach Club" },
    {hex:"#395BBF", count:1, title: "Pie", artist: "onthedal" },
    {hex:"#401F18", count:1, title: "표현", artist: "구원찬" },
    {hex:"#F2F2F2", count:1, title: "두류공원", artist: "구원찬" },
    {hex:"#255941", count:1, title: "날씨의 요정", artist: "신인류" }, 
    {hex:"#BABEBF", count:1, title: "sunny days", artist: "wave to earth" },
    {hex:"#CEDAF2", count:1, title: "사랑하자", artist: "소수빈" },
    {hex:"#BFAB45", count:1, title: "처음 만날 때처럼", artist: "잔나비" }, 
    {hex:"#A6926D", count:1, title: "바라본다면", artist: "곽진언" }, 
    {hex:"#F2B47E", count:1, title: "Flutter of a Butterfly", artist: "Anthony Lazaro, Jason LaPierre" } 
] 
},
  { date: "2025-11-02", 
  colors: [
    {hex:"#A7C0F2", count:7, title: "스며들기 좋은 오늘", artist: "백예린" }, 
    {hex:"#A7C0F2", count:1, title: "그건 아마 우리의 잘못은 아닐거야", artist: "백예린" }, 
    {hex:"#BFBDBE", count:1, title: "우주를 건너", artist: "백예린" },
    {hex:"#A7C0F2", count:1, title: "Our love is great", artist: "백예린" },
    {hex:"#F2EDE4", count:1, title: "popo", artist: "백예린" },
    {hex:"#F2CBC2", count:1, title: "Playing pretend", artist: "Sam Kim" },
    {hex:"#9CBF78", count:1, title: "여름가을겨울 봄.", artist: "잔나비" },
    {hex:"#8BB4D9", count:1, title: "너는 어떻게(Feat. 백예린)", artist: "구원찬" },
    {hex:"#2E84A6", count:1, title: "바람", artist: "최유리" },
    {hex:"#465573", count:3, title: "헤엄", artist: "박다솜" },
    {hex:"#CEECF2", count:1, title: "그대가 이렇게 내 맘에", artist: "이소라" },
    {hex:"#D9A0AB", count:1, title: "메아리 (Feat. 적재)", artist: "최유리" },
    {hex:"#F2D649", count:5, title: "포옹", artist: "Hookuo" },
    {hex:"#F20C8B", count:6, title: "다시 밤이 없겠고(LIVE)", artist: "잔치공동체" },
    {hex:"#03738C", count:1, title: "Oh Dear (Juniper Version)", artist: "Summer Salt" },
    {hex:"#BF3F57", count:1, title: "Nothing", artist: "Bruno Major" },
] },
  { date: "2025-11-03", 
  colors: [
    {hex:"#A2A644", count:1, title: "What Was I Made For? [From The Motion Picture Barbie]", artist: "Billie Eilish" },
    {hex:"#F2D680", count:1, title: "idontwannabeyouanymore", artist: "Billie Eilish" },
    {hex:"#F2C1BD", count:1, title: "Promenade", artist: "다린" },
    {hex:"#BF6211", count:1, title: "Enchantment", artist: "Corinne Bailey Rae" },
    {hex:"#6092A6", count:1, title: "Maybe We Could Be a Thing", artist: "Jesse Barrera, Michael Carreon & Albert Posis" },
    {hex:"#F2A766", count:1, title: "How Great Thou Art", artist: "Jordan Michael" },
    {hex:"#026873", count:1, title: "Santa Baby", artist: "Laufey" },
    {hex:"#F2A444", count:1, title: "Hold On Tight", artist: "Jesse Barrera 및 Albert Posis" },
    {hex:"#4F5939", count:1, title: "Lauren", artist: "Men I Trust" },
    {hex:"#9CBCD9", count:1, title: "검으나 아름답다(Vocal 김상진)", artist: "달빛마을" },
    {hex:"#F25D50", count:1, title: "May Ninth", artist: "Khruangbin" },
    {hex:"#F2E9BD", count:7, title: " Jesus The Lord Who Came To Earth For Me", artist: "Annointing" },





] }
];

let currentDay = 0; // 현재 표시 중인 날짜 index (0~4)

// 버튼 & 키보드 전환
document.getElementById('prev').onclick = ()=>changeDay(-1);
document.getElementById('next').onclick = ()=>changeDay(1);
// 키보드 이벤트 (좌우 전환 + trailMode 토글)
window.addEventListener('keydown', e=>{
  if (e.key === 'ArrowLeft')  changeDay(-1);
  if (e.key === 'ArrowRight') changeDay(1);

  // ✅ 'KeyT'는 입력기 상태(한/영)에 상관없이 항상 T키를 인식함
  if (e.code === 'KeyT') {
    trailMode = !trailMode;
    console.log('trailMode:', trailMode ? 'ON' : 'OFF');
  }
});
function changeDay(dir){
  const len = days.length;
  currentDay = (currentDay + dir + len) % len; // ✅ 루프 ON
}

function loop(){
  ctx.setTransform(1,0,0,1,0,0);
  
 if (trailMode) {
  // 잔상 효과: 완전 지우지 않고 투명한 어두운 막을 덮어서 색을 섞이게 함
  ctx.fillStyle = "rgba(13,15,21,0.05)";
  ctx.fillRect(0,0,W,H);
} else {
  // 잔상모드가 아닐 때는 기존처럼 완전 지움
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#0d0f15';
  ctx.fillRect(0,0,W,H);
}

  const cx = W/2, cy = H/2;
  const outerR = Math.min(W,H)*0.38;
  const labelRatio = 0.27;
  const innerR = outerR * labelRatio;

  // === 커서 거리 기반 속도 조절 (업데이트 버전) ===
let factor = 1.0;
if (isFinite(pointer.x) && isFinite(pointer.y)) {
  const dx = pointer.x - cx, dy = pointer.y - cy;
  const dist = Math.hypot(dx, dy);

  // ✅ 중앙 라벨 영역(내부 반경의 1.2배 이내)에 가까울수록 빠르게 회전
  if (dist <= innerR * 1.2) {
    factor = 13.0; // 최대 속도(가까이 갔을 때 13배) )
  } else if (dist < outerR) {
    const t = (dist - innerR * 1.2) / (outerR - innerR * 1.2);
    factor = 5.0 - 4.0 * t; // 5 → 1로 선형 감속
  } else {
    factor = 1.0; // 기본속도
  }

}

// ✅ 속도 반영 (Pause on Hover + 부드러운 감속 기능 추가)
const dx2 = pointer.x - cx;
const dy2 = pointer.y - cy;
const r2  = Math.hypot(dx2, dy2);

// 회전 속도를 부드럽게 조절하기 위한 가상 속도 변수
if (typeof loop.spinSpeed === 'undefined') loop.spinSpeed = baseSpeed;

// 도넛 위에 있을 때 → 천천히 감속 (목표 속도 = 0)
// 도넛 바깥 또는 중앙에 있을 때 → 원래 속도로 복귀
let targetSpeed = baseSpeed;
if (r2 > innerR && r2 < outerR) {
  targetSpeed = 0; // 도넛 위에서는 멈춤 목표
}

// 현재 속도를 목표 속도로 보간 (부드럽게 변화)
loop.spinSpeed += (targetSpeed - loop.spinSpeed) * 0.09;

// 실제 회전 적용 (보간된 속도로)
angle += (loop.spinSpeed * factor) / 60;

  // === 현재 날짜 데이터 불러오기 ===
  const day = days[currentDay];
  const total = day.colors.reduce((s,c)=>s+c.count,0);
  let startAng = -Math.PI/2;
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(angle);

  // 도넛 배경
  donutArc(innerR, outerR, 0, Math.PI*2, '#10131d');

  // 세그먼트 배열 초기화 (툴팁용 정보 저장)
currentSegments = [];

const EPS = 0.003; // 경계 점섬 완화용 아주 작은 오버랩(라디안)

// 데이터 기반 각도 비율로 채우기 + 세그먼트 기록
day.colors.forEach((c,i)=>{
  const ratio  = c.count / total;
  const endAng = startAng + ratio * Math.PI * 2;

  // 그리기(경계 틈 방지: 끝각을 살짝 더 칠함)
  donutArc(innerR, outerR, startAng, endAng + EPS, (c.hex || '').trim());

  // 세그먼트 기록(툴팁용)
  currentSegments.push({
    start: startAng,         // 시작 각도(라디안)  - 회전 전 기준
    end:   endAng,           // 끝 각도(라디안)    - 회전 전 기준
    hex:   (c.hex || '').trim(),
    title: c.title || '',    // 없으면 빈 문자열
    artist:c.artist || '',
    count: c.count
  });

  startAng = endAng;
});

  ctx.restore();
/* --- [툴팁 판별 & 표시] --- */
const tooltip = document.getElementById('tooltip');
let show = false;

if (isFinite(pointer.x) && isFinite(pointer.y)) {
  const dx = pointer.x - cx;
  const dy = pointer.y - cy;
  const r  = Math.hypot(dx, dy);

  if (r > innerR && r < outerR) {
    // 회전 보정
    let theta = Math.atan2(dy, dx) - angle;
    if (theta < 0) theta += Math.PI * 2;

    // 시작 기준(-PI/2) 맞추기 → 0..2PI
    let local = theta - (-Math.PI / 2);
    local %= (Math.PI * 2);
    if (local < 0) local += Math.PI * 2;

    for (let seg of currentSegments) {
      let s = seg.start - (-Math.PI / 2);
      let e = seg.end   - (-Math.PI / 2);
      if (s < 0) { s += Math.PI * 2; e += Math.PI * 2; }

      const inRange = (local >= s && local < e) ||
                      (e > Math.PI*2 && local < (e - Math.PI*2));

      if (inRange) {
        const name = (seg.title && seg.artist) ? `${seg.title} – ${seg.artist}` :
                     seg.title || seg.artist || seg.hex;

        tooltip.innerHTML = `
          <div class="row">
            <span class="dot" style="background:${seg.hex};"></span>
            <span class="text">${name}</span>
          </div>
        `;
        const offset = 12;
        tooltip.style.left = (lastClient.x + offset) + 'px';
        tooltip.style.top  = (lastClient.y + offset) + 'px';
        tooltip.style.display = 'block';
        show = true;
        break;
      }
    }
  }
}
if (!show) tooltip.style.display = 'none';
  // 중앙 라벨 (날짜만)
  ctx.save();
  ctx.translate(cx,cy);
  ctx.beginPath();
  ctx.arc(0,0,innerR*0.98,0,Math.PI*2);
  ctx.fillStyle='#151822';
  ctx.fill();
  ctx.fillStyle='#c9cfe6';
  ctx.font=`${Math.max(12,Math.round(innerR*0.20))}px system-ui`;
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.fillText(day.date,0,0);
  ctx.restore();

  requestAnimationFrame(loop);
}

function donutArc(r0,r1,a0,a1,color){
  ctx.beginPath();
  ctx.arc(0,0,r0,a0,a1,false);
  ctx.arc(0,0,r1,a1,a0,true);
  ctx.closePath();
  ctx.fillStyle=color;
  ctx.fill();
}

requestAnimationFrame(loop);
// === 툴팁 점(dot)의 테두리 자동 대비 설정 ===
function getLuminance(hex) {
  // HEX를 RGB로 변환
  const c = hex.replace('#','');
  const r = parseInt(c.substr(0,2),16)/255;
  const g = parseInt(c.substr(2,2),16)/255;
  const b = parseInt(c.substr(4,2),16)/255;
  // 감마 보정
  const srgb = [r,g,b].map(v=>v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055, 2.4));
  return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
}

// 툴팁 업데이트 시 점 테두리 색 자동 조정
const tooltipObserver = new MutationObserver(() => {
  const dot = document.querySelector('#tooltip .dot');
  if (!dot) return;
  const bg = getComputedStyle(dot).backgroundColor;
  const m = bg.match(/\d+/g);
  if (!m) return;
  const r = parseInt(m[0]), g = parseInt(m[1]), b = parseInt(m[2]);
  const luminance = (0.2126*r + 0.7152*g + 0.0722*b)/255;
  dot.style.borderColor = luminance > 0.6 ? 'rgba(0,0,0,0.35)' : 'rgba(255,255,255,0.28)';
});
const tooltipEl = document.getElementById('tooltip');
if (tooltipEl) {
  tooltipObserver.observe(tooltipEl, { childList: true, subtree: true });
} else {
  // DOM 생성 이후 다시 시도 (안전망)
  window.addEventListener('DOMContentLoaded', () => {
    const el = document.getElementById('tooltip');
    if (el) tooltipObserver.observe(el, { childList: true, subtree: true });
  });
}
</script>

<div id="tooltip" style="position:fixed; left:-9999px; top:-9999px; display:none; z-index:20;"></div>

</body>
</html>