<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LP Mood Wheel – 5day Test</title>
  <style>
    html, body { height:100%; margin:0; background:#0d0f15; overflow:hidden; }
    #c { display:block; width:100vw; height:100vh; }
    button.nav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  background:transparent;
  border:none;
  outline:none;
  cursor:pointer;
  user-select:none;

  width:88px; height:88px;           /* 2배 크기 */
  display:grid; place-items:center;
  transition:opacity .2s, transform .15s;
  opacity:.85;
}
button.nav:hover{
  opacity:1;
  transform:translateY(-50%) scale(1.05);
}
button.nav:active{
  transform:translateY(-50%) scale(0.96);
}

/* 위치 */
#prev{ left:2%; }
#next{ right:2%; }

/* 기본 화살표 (연한 회색) */
button.nav svg{
  width:50px; height:50px;
  stroke:#bfbfbf;
  stroke-width:1.0;
  fill:none;
  stroke-linecap:round;
  stroke-linejoin:round;
  transition:stroke .2s ease, opacity .2s ease;
  opacity:.9;
  pointer-events:none; /* 클릭 감지 방지 (버튼 전체 클릭) */
}

/* ✅ hover 시 화살표만 확실히 하얗게 */
button.nav:hover svg{
  stroke:#ffffff !important;
  opacity:1 !important;
  filter:drop-shadow(0 0 3px rgba(255,255,255,0.6)); /* 미세한 발광 */
}

/* --- Tooltip --- */
#tooltip {
  background: rgba(10,12,18,0.9);
  color: #E6E8EE;
  font: 13px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  padding: 8px 10px;
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 8px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  pointer-events: none;
  white-space: nowrap;
}
#tooltip .row {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
#tooltip .dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex: 0 0 10px;
  border: 1px solid rgba(255,255,255,0.25);
}
#tooltip .text {
  letter-spacing: 0.1px;
}
  </style>
</head>
<body>
  <canvas id="c"></canvas>
 <button id="prev" class="nav" aria-label="이전 날짜">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M15 6l-6 6 6 6"></path>
  </svg>
</button>

<button id="next" class="nav" aria-label="다음 날짜">
  <svg viewBox="0 0 24 24" aria-hidden="true">
    <path d="M9 6l6 6-6 6"></path>
  </svg>
</button>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let dpr = window.devicePixelRatio || 1;
let W, H;
function fit(){
  W = canvas.width = window.innerWidth * dpr;
  H = canvas.height = window.innerHeight * dpr;
}
window.addEventListener('resize', fit);
fit();

const DEG = Math.PI / 180;
let trailMode = true; // 잔상 모드 ON/OFF (T키로 토글)
let currentSegments = [];                  // 현재 날짜의 조각 정보(툴팁용)
let lastClient = { x: 0, y: 0 };           // ← 추가 2: 툴팁 위치용 윈도우 좌표

let baseSpeed = 60 * DEG; // 기본 회전 속도
let angle = 0;
let pointer = {x: Infinity, y: Infinity};
window.addEventListener('mousemove', e => {
  const rect = canvas.getBoundingClientRect();
  pointer.x = (e.clientX - rect.left)*dpr;
  pointer.y = (e.clientY - rect.top)*dpr;

  lastClient.x = e.clientX;  // ← 추가
  lastClient.y = e.clientY;  // ← 추가
});
canvas.addEventListener('mouseleave', ()=>{
  pointer.x = Infinity; pointer.y = Infinity;
});

// ==== 테스트용 데일리 데이터 ====
const days = [
  {
    date: "2025-10-30",
    colors: [
      { hex: "#F20C8B", count: 20 }, // 다시 밤이 없겠고
      { hex: "#DBA99E", count: 7 }, // s.o.s
      { hex: "#F2CD5C", count: 1 }, // cherry
      { hex: "#04BFAD", count: 1 }, // 내가 늘 의지하는 예수
      { hex: "#F2E9BD", count: 1 }, // 난 주를 기뻐해
      { hex: "#3F6F8C", count: 1 }, // Secret Codes
      { hex: "#BFBFBF", count: 1 }, // So Easy(To Fall In Love)
      { hex: "#8C8880", count: 1 }, // The Hardest Part
      { hex: "#A65389", count: 1 } // Dive
    ]
  },
  {
    date: "2025-10-31",
    colors: [
      { hex: "#595959", count: 7 }, // cry
      { hex: "#727372", count: 1 }, // Nothing's Gonna Hurt You Baby
      { hex: "#736F68", count: 4 }, // complicated
      { hex: "#275AF2", count: 1 }, // Ever
      { hex: "#3A5936", count: 1 }, // Green
      { hex: "#F2F2F2", count: 2 }, // Oh Rosy
      { hex: "#F2B3C4", count: 6 } // Dancing on the table
    ]
  },
  { date: "2025-11-01", 
  colors: [
    {hex:"#BF2121", count:1}, // 우리들의 순간
    {hex:"#D9C091", count:1}, // 왠지 그럼 안될 것 같아
    {hex:"#F20C0C", count:1}, // wish 
    {hex:"#F27405", count:1}, // her
    {hex:"#395BBF", count:1}, // pie
    {hex:"#401F18", count:1}, // 표현
    {hex:"#F2F2F2", count:1}, // 두류공원
    {hex:"#255941", count:1}, // 날씨의 요정
    {hex:"#BABEBF", count:1}, // sunny days
    {hex:"#CEDAF2", count:1}, // 사랑하자
    {hex:"#BFAB45", count:1}, // 처음 만날 때처럼 
    {hex:"#A6926D", count:1}, // 바라본다면
    {hex:"#F2B47E", count:1} // Flutter of a Butterfly
] 
},
  { date: "2025-11-02", 
  colors: [
    {hex:"#A7C0F2", count:7}, // 스며들기 좋은 오늘
    {hex:"#A7C0F2", count:1}, // 그건 아마 우리의 잘못은 아닐거야
    {hex:"#BFBDBE", count:1}, // 우주를 건너
    {hex:"#A7C0F2", count:1}, // Our love is great
    {hex:"#F2EDE4", count:1}, // popo
    {hex:"#F2CBC2", count:1}, // Playing pretend
    {hex:"#9CBF78", count:1}, // 여름가을겨울 봄
    {hex:"#8BB4D9", count:1}, // 너는 어떻게
    {hex:"#2E84A6", count:1}, // 바람
    {hex:"#465573", count:3}, // 헤엄
    {hex:"#CEECF2", count:1}, // 그대가 이렇게 내 맘에
    {hex:"#D9A0AB", count:1}, // 메아리
    {hex:"#F2D649", count:5}, // 포옹
    { hex: "#F20C8B", count:6}, // 다시 밤이 없겠고
    {hex:"#221100", count:1},
    {hex:"#221100", count:1},
] },
  { date: "2025-11-03", colors: [{hex:"#9988AA", count:1}] }
];

let currentDay = 0; // 현재 표시 중인 날짜 index (0~4)

// 버튼 & 키보드 전환
document.getElementById('prev').onclick = ()=>changeDay(-1);
document.getElementById('next').onclick = ()=>changeDay(1);
// 키보드 이벤트 (좌우 전환 + trailMode 토글)
window.addEventListener('keydown', e=>{
  if (e.key === 'ArrowLeft')  changeDay(-1);
  if (e.key === 'ArrowRight') changeDay(1);

  // ✅ 'KeyT'는 입력기 상태(한/영)에 상관없이 항상 T키를 인식함
  if (e.code === 'KeyT') {
    trailMode = !trailMode;
    console.log('trailMode:', trailMode ? 'ON' : 'OFF');
  }
});
function changeDay(dir){
  const len = days.length;
  currentDay = (currentDay + dir + len) % len; // ✅ 루프 ON
}

function loop(){
  ctx.setTransform(1,0,0,1,0,0);
  
 if (trailMode) {
  // 잔상 효과: 완전 지우지 않고 투명한 어두운 막을 덮어서 색을 섞이게 함
  ctx.fillStyle = "rgba(13,15,21,0.06)";
  ctx.fillRect(0,0,W,H);
} else {
  // 잔상모드가 아닐 때는 기존처럼 완전 지움
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#0d0f15';
  ctx.fillRect(0,0,W,H);
}

  const cx = W/2, cy = H/2;
  const outerR = Math.min(W,H)*0.38;
  const labelRatio = 0.27;
  const innerR = outerR * labelRatio;

  // === 커서 거리 기반 속도 조절 (업데이트 버전) ===
let factor = 1.0;
if (isFinite(pointer.x) && isFinite(pointer.y)) {
  const dx = pointer.x - cx, dy = pointer.y - cy;
  const dist = Math.hypot(dx, dy);

  // ✅ 중앙 라벨 영역(내부 반경의 1.2배 이내)에 가까울수록 빠르게 회전
  if (dist <= innerR * 1.2) {
    factor = 13.0; // 최대 속도(가까이 갔을 때 13배) )
  } else if (dist < outerR) {
    const t = (dist - innerR * 1.2) / (outerR - innerR * 1.2);
    factor = 5.0 - 4.0 * t; // 5 → 1로 선형 감속
  } else {
    factor = 1.0; // 기본속도
  }

  // 확인용 로그 (필요 시 삭제 가능)
  console.log('dist:', dist.toFixed(1), 'factor:', factor.toFixed(2));
}

// ✅ 속도 반영
angle += (baseSpeed * factor) / 60;

  // === 현재 날짜 데이터 불러오기 ===
  const day = days[currentDay];
  const total = day.colors.reduce((s,c)=>s+c.count,0);
  let startAng = -Math.PI/2;
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(angle);

  // 도넛 배경
  donutArc(innerR, outerR, 0, Math.PI*2, '#10131d');

  // 세그먼트 배열 초기화 (툴팁용 정보 저장)
currentSegments = [];

const EPS = 0.002; // 경계 점섬 완화용 아주 작은 오버랩(라디안)

// 데이터 기반 각도 비율로 채우기 + 세그먼트 기록
day.colors.forEach((c,i)=>{
  const ratio  = c.count / total;
  const endAng = startAng + ratio * Math.PI * 2;

  // 그리기(경계 틈 방지: 끝각을 살짝 더 칠함)
  donutArc(innerR, outerR, startAng, endAng + EPS, (c.hex || '').trim());

  // 세그먼트 기록(툴팁용)
  currentSegments.push({
    start: startAng,         // 시작 각도(라디안)  - 회전 전 기준
    end:   endAng,           // 끝 각도(라디안)    - 회전 전 기준
    hex:   (c.hex || '').trim(),
    title: c.title || '',    // 없으면 빈 문자열
    artist:c.artist || '',
    count: c.count
  });

  startAng = endAng;
});

  ctx.restore();
/* --- [툴팁 판별 & 표시] --- */
const tooltip = document.getElementById('tooltip');
let show = false;

if (isFinite(pointer.x) && isFinite(pointer.y)) {
  const dx = pointer.x - cx;
  const dy = pointer.y - cy;
  const r  = Math.hypot(dx, dy);

  if (r > innerR && r < outerR) {
    // 회전 보정
    let theta = Math.atan2(dy, dx) - angle;
    if (theta < 0) theta += Math.PI * 2;

    // 시작 기준(-PI/2) 맞추기 → 0..2PI
    let local = theta - (-Math.PI / 2);
    local %= (Math.PI * 2);
    if (local < 0) local += Math.PI * 2;

    for (let seg of currentSegments) {
      let s = seg.start - (-Math.PI / 2);
      let e = seg.end   - (-Math.PI / 2);
      if (s < 0) { s += Math.PI * 2; e += Math.PI * 2; }

      const inRange = (local >= s && local < e) ||
                      (e > Math.PI*2 && local < (e - Math.PI*2));

      if (inRange) {
        const name = (seg.title && seg.artist) ? `${seg.title} – ${seg.artist}` :
                     seg.title || seg.artist || seg.hex;

        tooltip.innerHTML = `
          <div class="row">
            <span class="dot" style="background:${seg.hex};"></span>
            <span class="text">${name}</span>
          </div>
        `;
        const offset = 12;
        tooltip.style.left = (lastClient.x + offset) + 'px';
        tooltip.style.top  = (lastClient.y + offset) + 'px';
        tooltip.style.display = 'block';
        show = true;
        break;
      }
    }
  }
}
if (!show) tooltip.style.display = 'none';
  // 중앙 라벨 (날짜만)
  ctx.save();
  ctx.translate(cx,cy);
  ctx.beginPath();
  ctx.arc(0,0,innerR*0.98,0,Math.PI*2);
  ctx.fillStyle='#1a1e29';
  ctx.fill();
  ctx.fillStyle='#cfd5ff';
  ctx.font=`${Math.max(12,Math.round(innerR*0.20))}px system-ui`;
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.fillText(day.date,0,0);
  ctx.restore();

  requestAnimationFrame(loop);
}

function donutArc(r0,r1,a0,a1,color){
  ctx.beginPath();
  ctx.arc(0,0,r0,a0,a1,false);
  ctx.arc(0,0,r1,a1,a0,true);
  ctx.closePath();
  ctx.fillStyle=color;
  ctx.fill();
}

requestAnimationFrame(loop);
</script>

<div id="tooltip" style="position:fixed; left:-9999px; top:-9999px; display:none; z-index:20;"></div>

</body>
</html>